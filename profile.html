<!DOCTYPE html>
<html  lang="en">
  <head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Hirah Attar - User Profile</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;800&amp;family=Cairo:wght@400;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<script>
  (function () {
    const token = localStorage.getItem("token");
    const raw = localStorage.getItem("user");
  
    if (!token || !raw) {
      window.location.href = "index.html";
      return;
    }
  
    const user = JSON.parse(raw);
  
    // ONLY normal users allowed
    if (user.role !== "user") {
      window.location.href = "index.html";
    }
  })();
  </script>
  
<script id="tailwind-config">
        tailwind.config = {
          darkMode: "class",
          theme: {
            extend: {
              colors: {
                "primary": "#C89B3F", // Gold
                "secondary": "#0A192F", // Deep Navy
                "accent": "#F5F1E9", // Cream
                "bronze": "#A97142",
                "light-bg": "#F9F6F2",
                "dark-bg": "#071324",
                "light-text": "#3D3D3D",
                "dark-text": "#E0E0E0",
                "success": "#28a745",
                "warning": "#ffc107",
                "danger": "#dc3545",
              },
              fontFamily: {
                "display": ["Playfair Display", "serif"],
                "body": ["Cairo", "sans-serif"],
              },
              boxShadow: {
                'glow-gold': '0 0 15px 0px rgba(200, 155, 63, 0.3)',
                'glow-bronze': '0 0 15px 0px rgba(169, 113, 66, 0.3)',
                'card-lift': '0 10px 20px -5px rgba(0, 0, 0, 0.1)',
              },
              animation: {
                'fade-in': 'fade-in 0.5s ease-out forwards',
                'fade-in-up': 'fade-in-up 0.6s ease-out forwards',
                'pop-in': 'pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                'slide-in-right': 'slide-in-right 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards',
              },
              keyframes: {
                'fade-in': { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                'fade-in-up': {
                  '0%': { opacity: '0', transform: 'translateY(20px)' },
                  '100%': { opacity: '1', transform: 'translateY(0)' },
                },
                'pop-in': {
                  '0%': { opacity: '0', transform: 'scale(0.9)' },
                  '100%': { opacity: '1', transform: 'scale(1)' },
                },
                'slide-in-right': {
  '0%': { transform: 'translateX(100%)' },
  '100%': { transform: 'translateX(0)' },
},
              }
            },
          },
        }
    </script>

    
<style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24 }
        .material-symbols-outlined.filled { font-variation-settings: 'FILL' 1 }
        .sidebar-group:hover .sidebar-icon { transform: scale(1.1); color: var(--hover-color); }
        .sidebar-group:hover .sidebar-label { color: var(--hover-color); transform: translateX(2px); }
        .dark .sidebar-group:hover { --hover-color: #C89B3F; }.light .sidebar-group:hover { --hover-color: #A97142; }[x-cloak] { display: none !important; }
    </style>

<script defer="" src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script>
  // üîê HARD AUTH GUARD
  if (!localStorage.getItem("token")) {
    window.location.replace("index.html");
  }
</script>

<script>
  

  function appState() {
    return {
      sidebarOpen: true,
      mobileMenuOpen: false,
      activeView: "overview",
      user: JSON.parse(localStorage.getItem("user")),
      showPasswordPanel: false,
      showSessionPanel: false,
showDeletePanel: false,

      init() {
  // Called automatically by Alpine on mount
},

review: {
  open: false,
  queue: [],
  index: 0,
  rating: 0,
  hover: 0,
  comment: "",
  orderId: null,

  current() {
    return this.queue[this.index] || null;
  },

  openFromQueue(queue, orderId, startProductId = null) {
    if (!Array.isArray(queue)) return;

    // üîí HARD LOCK: never show reviewed again (frontend cache)
   

    this.queue = queue.filter(
      q =>
        !q.reviewed &&
        !reviewedCache.includes(String(q.productId))
    );

    // üéØ Route to product user came from
    if (startProductId) {
      const idx = this.queue.findIndex(
        q => String(q.productId) === String(startProductId)
      );
      this.index = idx >= 0 ? idx : 0;
    } else {
      this.index = 0;
    }

    this.rating = 0;
    this.hover = 0;
    this.comment = "";
    this.orderId = orderId;

    if (this.queue.length === 0) {
      this.open = false;
      return;
    }

    this.open = true;
  },

  advance() {
    let next = this.index + 1;

    while (
      next < this.queue.length &&
      this.queue[next].reviewed === true
    ) {
      next++;
    }

    if (next >= this.queue.length) {
      this.open = false;
      return;
    }

    this.index = next;
    this.rating = 0;
    this.hover = 0;
    this.comment = "";
  },

  async done() {
    const current = this.current();
    if (!current) return;

    try {
      const token = localStorage.getItem("token");

      const res = await fetch("https://perfume-store-production.up.railway.app/api/products/review", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({
          productId: current.productId,
          orderId: this.orderId,
          rating: this.rating,
          comment: this.comment
        })
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.message);

      // üîí HARD LOCK permanently (frontend cache)
      current.reviewed = true;

   

      reviewedCache.push(String(current.productId));
      localStorage.setItem(
        "__reviewedProducts",
        JSON.stringify([...new Set(reviewedCache)])
      );

      this.advance();

    } catch (err) {
      console.error("Review submit failed:", err);
      alert("Failed to submit review");
    }
  },

  skip() {
    const current = this.current();
    if (!current) return;

    // ‚è∏ TEMP skip only (session)
    current._sessionSkipped = true;
    this.advance();
  },

  cancel() {
    this.open = false;
  }
}


      
    };
  }
</script>
<script src="/assets/js/font.js"></script>
</head>

<script>
  /* ================= AUTH GUARD ================= */
  (function () {
    if (!localStorage.getItem("token")) {
      if (!location.pathname.endsWith("index.html")) {
        window.location.href = "/index.html";
      }
    }
  })();
  
  /* ================= USER HELPERS ================= */
  function getUser() {
    const raw = localStorage.getItem("user");
    if (!raw) return null;
    return JSON.parse(raw);
  }
  
  function setUser(patch) {
    const current = getUser() || {};
    const updated = { ...current, ...patch };
    localStorage.setItem("user", JSON.stringify(updated));
  }
  
  /* ================= INITIALS AVATAR ================= */
  function getInitialsAvatar(user) {
    const name = user.name || user.email.split("@")[0];
    const initials = name
      .split(" ")
      .map(w => w[0])
      .join("")
      .substring(0, 2)
      .toUpperCase();
  
    return `https://ui-avatars.com/api/?name=${initials}&background=8B5A2B&color=fff`;
  }
  
  /* ================= SYNC UI (ALL AVATARS) ================= */
  function syncAvatarUI() {
    const user = getUser();
    if (!user) return;
  
    const avatarUrl = user.avatar || getInitialsAvatar(user);
  
    document
      .querySelectorAll("[data-user-avatar], #avatarPreview")
      .forEach(img => {
        img.src = avatarUrl + "?v=" + Date.now();
      });
  }
  
  /* ================= AVATAR UPLOAD ================= */
  async function uploadAvatar(event) {
    const file = event.target.files[0];
    if (!file) return;
  
    /* Instant preview */
    const reader = new FileReader();
    reader.onload = e => {
      document.getElementById("avatarPreview").src = e.target.result;
    };
    reader.readAsDataURL(file);
  
    try {
      const token = localStorage.getItem("token");
      const formData = new FormData();
      formData.append("avatar", file);
  
      const res = await fetch("https://perfume-store-production.up.railway.app/api/users/avatar", {
        method: "PUT",
        headers: {
          Authorization: `Bearer ${token}`,
        },
        body: formData,
      });
  
      const data = await res.json();
      if (!res.ok) throw new Error(data.message);
  
      /* Save ONE source of truth */
      setUser({ avatar: data.user.avatar });
  
      syncAvatarUI();
  
    } catch (err) {
      console.error(err);
      alert("Avatar upload failed");
    } finally {
      event.target.value = "";
    }
  }
  
  /* ================= REMOVE AVATAR ================= */
  async function removeAvatar() {
    try {
      const token = localStorage.getItem("token");
  
      await fetch("https://perfume-store-production.up.railway.app/api/users/avatar", {
        method: "DELETE",
        headers: {
          Authorization: `Bearer ${token}`,
        },
      });
  
      setUser({ avatar: null });
      syncAvatarUI();
  
    } catch (err) {
      console.error(err);
      alert("Failed to remove avatar");
    }
  }
  
  /* ================= PAGE INIT ================= */
  document.addEventListener("DOMContentLoaded", () => {
    syncAvatarUI();
  });
  
  /* ================= LOGOUT ================= */
  function logout() {
    localStorage.clear();
    window.location.href = "index.html";
  }
  </script>
<script>
  /* ================= SYNC NAME & EMAIL ================= */
  function syncUserTextUI() {
    const user = getUser();
    if (!user) return;
  
    // Name
    document.querySelectorAll("[data-user-name]").forEach(el => {
      el.textContent = user.name || user.email.split("@")[0];
    });
  
    // Email
    document.querySelectorAll("[data-user-email]").forEach(el => {
      el.textContent = user.email;
    });
  }
  async function saveProfileName() {
  const input = document.getElementById("display-name");
  if (!input) return;

  const newName = input.value.trim();
  if (!newName) {
    alert("Display name cannot be empty");
    return;
  }

  try {
    const token = localStorage.getItem("token");

    const res = await fetch("https://perfume-store-production.up.railway.app/api/users/profile", {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`,
      },
      body: JSON.stringify({ name: newName }),
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.message);

    // ‚úÖ Update ONLY the name (email untouched)
    setUser({ name: data.user.name });

    // ‚úÖ Sync text everywhere
    syncUserTextUI();

    alert("Profile updated successfully");

  } catch (err) {
    console.error(err);
    alert("Failed to update name");
  }
}

async function logoutAllDevices() {
  try {
    const token = localStorage.getItem("token");

    await fetch("https://perfume-store-production.up.railway.app/api/users/logout-all", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${token}`,
      },
    });

  } catch (err) {
    // Even if backend fails, we still log out locally
    console.error("Logout all failed:", err);
  } finally {
    // Clear local state and redirect
    localStorage.clear();
    window.location.href = "index.html";
  }
}

  </script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const user = getUser();
  if (!user) return;

  // Fill inputs
  const nameInput = document.getElementById("display-name");
  const emailInput = document.getElementById("email");

  if (nameInput) nameInput.value = user.name || "";
  if (emailInput) emailInput.value = user.email || "";

  // Sync UI everywhere
  syncAvatarUI();
  syncUserTextUI();
  renderLoyaltyBadge();

});

  </script>
  
  
  
    
  <body
  class="bg-light-bg dark:bg-dark-bg font-body text-light-text dark:text-dark-text transition-colors duration-500"
  x-data="appState()"
  x-ref="root"
>

<div class="flex min-h-screen overflow-x-hidden">
  <aside :class="{'w-72': sidebarOpen, 'w-20': !sidebarOpen}" class="fixed left-0 top-0 h-full bg-accent dark:bg-secondary text-light-text dark:text-dark-text shadow-lg z-30 transition-all duration-300 ease-in-out hidden lg:flex flex-col border-r border-bronze/10 dark:border-primary/10">
<div :class="{'px-6': sidebarOpen, 'px-0': !sidebarOpen}" class="flex items-center justify-center h-20 border-b border-bronze/10 dark:border-primary/10 transition-all duration-300">
<a class="flex items-center gap-3" href="#">
<div class="h-8 w-8 text-bronze dark:text-primary flex-shrink-0">
<svg fill="currentColor" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path d="M24 0.757355L47.2426 24L24 47.2426L0.757355 24L24 0.757355ZM21 35.7574V12.2426L9.24264 24L21 35.7574Z"></path></svg>
</div>
<span :class="{'opacity-100': sidebarOpen, 'opacity-0': !sidebarOpen}" class="text-xl font-bold font-display text-light-text dark:text-accent whitespace-nowrap overflow-hidden transition-opacity duration-200">Hirah Attar</span>
</a>
</div>
<div :class="{
  'opacity-100 py-6': sidebarOpen,
  'opacity-100 py-3': !sidebarOpen
}"
 class="flex flex-col items-center justify-center border-b border-bronze/10 dark:border-primary/10 transition-all duration-300  px-4">
<div @click="activeView = 'edit'" class="relative group cursor-pointer">
  <img data-user-avatar class="h-20 w-20 rounded-full object-cover">
  <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
<span class="material-symbols-outlined text-white drop-shadow-md">edit</span>
</div>
</div>
<h3 data-user-name class="mt-3 font-display font-bold text-lg text-center truncate w-full" x-text="user.name"></h3>
<p data-user-email class="text-xs text-light-text/60 dark:text-dark-text/60 truncate w-full text-center" x-text="user.email"></p>
</div>
<nav class="flex-grow pt-6 px-4 space-y-2 overflow-y-auto">
<a :class="{ 'bg-bronze/10 dark:bg-primary/10 text-bronze dark:text-primary': activeView === 'overview', 'hover:bg-bronze/5 dark:hover:bg-primary/5': activeView !== 'overview' }" @click.prevent="activeView = 'overview'" class="sidebar-group flex items-center p-3 rounded-lg transition-all duration-200 cursor-pointer" style="--hover-color: #A97142;" x-bind:class="{ 'dark: [--hover-color:#C89B3F]': true }">
<span class="material-symbols-outlined sidebar-icon transition-transform duration-200">badge</span>
<span :class="{'opacity-100 w-auto': sidebarOpen, 'opacity-0 w-0': !sidebarOpen}" class="ml-4 font-semibold sidebar-label whitespace-nowrap overflow-hidden transition-all duration-200">Overview</span>
</a>
<a :class="{ 'bg-bronze/10 dark:bg-primary/10 text-bronze dark:text-primary': activeView === 'edit', 'hover:bg-bronze/5 dark:hover:bg-primary/5': activeView !== 'edit' }" @click.prevent="activeView = 'edit'" class="sidebar-group flex items-center p-3 rounded-lg transition-all duration-200 cursor-pointer" style="--hover-color: #A97142;" x-bind:class="{ 'dark: [--hover-color:#C89B3F]': true }">
<span class="material-symbols-outlined sidebar-icon transition-transform duration-200">edit_square</span>
<span :class="{'opacity-100 w-auto': sidebarOpen, 'opacity-0 w-0': !sidebarOpen}" class="ml-4 font-semibold sidebar-label whitespace-nowrap overflow-hidden transition-all duration-200">Edit Profile</span>
</a>
<a :class="{ 'bg-bronze/10 dark:bg-primary/10 text-bronze dark:text-primary': activeView === 'orders', 'hover:bg-bronze/5 dark:hover:bg-primary/5': activeView !== 'orders' }" @click.prevent="
activeView = 'orders';
setTimeout(openOrdersView, 0);
" class="sidebar-group flex items-center p-3 rounded-lg transition-all duration-200 cursor-pointer" style="--hover-color: #A97142;" x-bind:class="{ 'dark: [--hover-color:#C89B3F]': true }">
<span class="material-symbols-outlined sidebar-icon transition-transform duration-200">shopping_bag</span>
<span :class="{'opacity-100 w-auto': sidebarOpen, 'opacity-0 w-0': !sidebarOpen}" class="ml-4 font-semibold sidebar-label whitespace-nowrap overflow-hidden transition-all duration-200">My Orders</span>
</a>
<a :class="{ 'bg-bronze/10 dark:bg-primary/10 text-bronze dark:text-primary': activeView === 'security', 'hover:bg-bronze/5 dark:hover:bg-primary/5': activeView !== 'security' }" @click.prevent="activeView = 'security'" class="sidebar-group flex items-center p-3 rounded-lg transition-all duration-200 cursor-pointer" style="--hover-color: #A97142;" x-bind:class="{ 'dark: [--hover-color:#C89B3F]': true }">
<span class="material-symbols-outlined sidebar-icon transition-transform duration-200">lock</span>
<span :class="{'opacity-100 w-auto': sidebarOpen, 'opacity-0 w-0': !sidebarOpen}" class="ml-4 font-semibold sidebar-label whitespace-nowrap overflow-hidden transition-all duration-200">Security</span>
</a>
<!-- DETAILS -->
<a
  :class="{
    'bg-bronze/10 dark:bg-primary/10 text-bronze dark:text-primary': activeView === 'details',
    'hover:bg-bronze/5 dark:hover:bg-primary/5': activeView !== 'details'
  }"
  @click.prevent="activeView = 'details'"
  class="sidebar-group flex items-center p-3 rounded-lg transition-all duration-200 cursor-pointer"
  style="--hover-color: #A97142;"
>
  <span class="material-symbols-outlined sidebar-icon">contact_mail</span>
  <span
    :class="{'opacity-100 w-auto': sidebarOpen, 'opacity-0 w-0': !sidebarOpen}"
    class="ml-4 font-semibold sidebar-label whitespace-nowrap overflow-hidden transition-all duration-200"
  >
    Details
  </span>
</a>

</nav>
<div class="p-4 border-t border-bronze/10 dark:border-primary/10">
<a onclick="logout()" class="sidebar-group flex items-center p-3 rounded-lg hover:bg-bronze/5 dark:hover:bg-primary/5 transition-all duration-200 text-danger" href="#" style="--hover-color: #dc3545;" x-bind:class="{ 'dark: [--hover-color:#dc3545]': true }">
<span class="material-symbols-outlined sidebar-icon transition-transform duration-200">logout</span>
<span  :class="{'opacity-100 w-auto': sidebarOpen, 'opacity-0 w-0': !sidebarOpen}" class="ml-4 font-semibold sidebar-label whitespace-nowrap overflow-hidden transition-all duration-200">Logout</span>
</a>
</div>
</aside>
<div :class="{'lg:ml-72': sidebarOpen, 'lg:ml-20': !sidebarOpen}" class="relative flex flex-col flex-1 overflow-y-auto overflow-x-hidden">
<header class="sticky top-0 bg-light-bg/80 dark:bg-dark-bg/80 backdrop-blur-lg z-20 shadow-sm border-b border-bronze/5 dark:border-primary/5">
<div class="px-4 sm:px-6 lg:px-8">
<div class="flex items-center justify-between h-20 -mb-px">
<div class="flex items-center space-x-4">
<button @click.stop="sidebarOpen = !sidebarOpen" class="text-light-text dark:text-dark-text hover:text-bronze dark:hover:text-primary hidden lg:block">
<span class="material-symbols-outlined text-3xl">menu_open</span>
</button>

<div class="hidden sm:block">
<h1 class="font-display font-bold text-xl text-bronze dark:text-primary">Welcome, <span x-text="user.name.split(' ')[0]"></span></h1>
</div>
</div>
<div class="flex items-center space-x-4">
<button @click="document.documentElement.classList.toggle('dark')" class="flex h-10 w-10 cursor-pointer items-center justify-center rounded-full bg-transparent text-bronze dark:text-primary transition-transform duration-500 ease-in-out hover:rotate-[360deg] hover:bg-bronze/10 dark:hover:bg-primary/10">
<span class="material-symbols-outlined hidden dark:inline">light_mode</span>
<span class="material-symbols-outlined dark:hidden">dark_mode</span>
</button>
<div
  class="relative"
  x-data="userNotifications()"
  x-init="loadNotifications()"
><button @click="open = !open" class="flex h-10 w-10 items-center justify-center rounded-full bg-bronze/10 dark:bg-primary/10 text-bronze dark:text-primary hover:bg-bronze/20 transition-colors">
<span class="material-symbols-outlined">notifications</span>
<span
  x-show="unreadCount > 0"
  x-text="unreadCount"
  class="absolute -top-1 -right-1 min-w-[18px] h-[18px] px-1 text-[10px]
         flex items-center justify-center rounded-full bg-danger text-white"
></span></button>
<div @click.outside="open = false" class="absolute right-0 mt-2 w-72 bg-accent dark:bg-secondary rounded-lg shadow-lg overflow-hidden border border-bronze/10 dark:border-primary/10 z-50" x-cloak="" x-show="open" x-transition:enter="transition ease-out duration-200" x-transition:enter-end="opacity-100 scale-100" x-transition:enter-start="opacity-0 scale-95" x-transition:leave="transition ease-in duration-75" x-transition:leave-end="opacity-0 scale-95" x-transition:leave-start="opacity-100 scale-100">
<div class="p-3 font-semibold border-b border-bronze/10 dark:border-primary/10">Order Updates</div>
<div
  class="max-h-72 overflow-y-auto divide-y divide-bronze/10 dark:divide-primary/10"
>
  <!-- No unread notifications -->
  <template x-if="unread.length === 0">
    <div class="p-4 text-sm text-light-text/70 dark:text-dark-text/70 text-center">
      No new notifications
    </div>
  </template>

  <!-- UNREAD notifications only -->
  <template x-for="n in unread" :key="n._id">
    <div
      @click="markAsRead(n)"
      class="block p-3 cursor-pointer hover:bg-bronze/5 dark:hover:bg-primary/5 bg-bronze/5 dark:bg-primary/5"
    >
      <p class="font-semibold" x-text="n.title"></p>
      <p
        class="text-xs text-light-text/70 dark:text-dark-text/70"
        x-text="n.message"
      ></p>
    </div>
  </template>

  <!-- View all button -->
  <button
  onclick="openNotificationModal(window.__userNotifications || [])"
  class="w-full text-center py-2 text-sm hover:bg-bronze/10 dark:hover:bg-primary/10"
>
  View all notifications
</button>
</div>

</div>

</div>

<div class="relative" x-data="{ open: false }">
<button @click="open = !open" class="flex items-center space-x-2 focus:outline-none">
  <img data-user-avatar class="h-10 w-10 rounded-full object-cover">
  <span class="material-symbols-outlined text-light-text dark:text-dark-text text-sm">expand_more</span>
</button>
<div @click.outside="open = false" class="absolute right-0 mt-2 w-48 bg-accent dark:bg-secondary rounded-lg shadow-lg overflow-hidden border border-bronze/10 dark:border-primary/10 z-50" x-cloak="" x-show="open" x-transition:enter="transition ease-out duration-200" x-transition:enter-end="opacity-100 scale-100" x-transition:enter-start="opacity-0 scale-95" x-transition:leave="transition ease-in duration-75" x-transition:leave-end="opacity-0 scale-95" x-transition:leave-start="opacity-100 scale-100">
<div class="border-t border-bronze/10 dark:border-primary/10"></div>
<a onclick="logout()"
   class="block px-4 py-2 text-sm text-danger hover:bg-danger/10 cursor-pointer">
  Logout
</a>
</div>
</div>
<button @click.stop="mobileMenuOpen = !mobileMenuOpen"
        class="text-light-text dark:text-dark-text lg:hidden">
  <span class="material-symbols-outlined text-3xl">menu</span>
</button>
</div>
</div>
</div>
</header>
<main class="flex-grow p-4 sm:p-6 lg:p-8 max-w-7xl mx-auto w-full">
<div class="animate-fade-in" x-show="activeView === 'overview'" x-transition:enter="transition ease-out duration-300" x-transition:enter-end="opacity-100" x-transition:enter-start="opacity-0">
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
<div class="lg:col-span-2 bg-accent dark:bg-secondary rounded-xl border border-bronze/10 dark:border-primary/10 shadow-sm overflow-hidden animate-fade-in-up" style="animation-delay: 100ms;">
<div class="bg-gradient-to-r from-bronze/20 to-primary/20 h-32"></div>
<div class="px-6 pb-6 relative">
  <div class="relative -mt-10 mb-4 flex justify-between items-end">
      <img data-user-avatar class="h-24 w-24 rounded-full object-cover">
  <button @click="activeView = 'edit'" class="px-4 py-2 bg-bronze dark:bg-primary text-white dark:text-secondary font-semibold text-sm rounded-lg hover:opacity-90 transition shadow-md flex items-center">
<span class="material-symbols-outlined text-sm mr-2">edit</span> Edit Profile
                                </button>
</div>
<h2 class="text-3xl font-display font-bold text-light-text dark:text-dark-text" x-text="user.name"></h2>
<div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
<div class="p-3 rounded-lg bg-light-bg dark:bg-dark-bg border border-bronze/5 dark:border-primary/5">
<p class="text-xs text-light-text/60 dark:text-dark-text/60 uppercase tracking-wider">Email Address</p>
<p data-user-email class="font-medium mt-1 truncate" x-text="user.email"></p>
</div>
<div class="p-3 rounded-lg bg-light-bg dark:bg-dark-bg border border-bronze/5 dark:border-primary/5">
<p class="text-xs text-light-text/60 dark:text-dark-text/60 uppercase tracking-wider">Member Since</p>
<p id="joinedDate" class="font-medium mt-1">‚Äî</p>
</div>
<div class="p-3 rounded-lg bg-light-bg dark:bg-dark-bg border border-bronze/5 dark:border-primary/5">
  <p class="text-xs text-light-text/60 dark:text-dark-text/60 uppercase tracking-wider">
    Total Money Spent
  </p>
  <p id="totalSpent" class="font-medium mt-1">Rs. 0.00</p>
</div>

<div class="p-3 rounded-lg bg-light-bg dark:bg-dark-bg border border-bronze/5 dark:border-primary/5">
<p class="text-xs text-light-text/60 dark:text-dark-text/60 uppercase tracking-wider">Loyalty Tier</p>
<p
  id="loyaltyBadge"
  class="font-medium mt-1 flex items-center"
>
  ‚Äî
</p>

</div>
</div>
</div>
</div>
<div class="bg-accent dark:bg-secondary rounded-xl border border-bronze/10 dark:border-primary/10 shadow-sm p-6 animate-fade-in-up flex flex-col justify-center space-y-6" style="animation-delay: 200ms;">
<h3 class="font-display font-bold text-lg border-b border-bronze/10 dark:border-primary/10 pb-2">Activity Summary</h3>
<div class="flex items-center justify-between">
<div class="flex items-center">
<div class="p-3 rounded-lg bg-bronze/10 dark:bg-primary/10 text-bronze dark:text-primary mr-4">
<span class="material-symbols-outlined">shopping_bag</span>
</div>
<div>
  <p id="totalOrdersCount" class="text-2xl font-bold font-display">0</p>
  <p class="text-xs text-light-text/60 dark:text-dark-text/60">Total Orders</p>
  
</div>
</div>
</div>
<div class="flex items-center justify-between">
<div class="flex items-center">
<div class="p-3 rounded-lg bg-bronze/10 dark:bg-primary/10 text-bronze dark:text-primary mr-4">
  <span class="material-symbols-outlined">done_all</span>
</div>
<div>
  <p id="completedOrdersCount" class="text-2xl font-bold font-display">0</p>
  <p class="text-xs text-light-text/60 dark:text-dark-text/60">Completed Orders</p>
  
</div>
</div>
</div>
<button @click="activeView = 'orders'" class="w-full mt-4 py-2 border border-bronze/20 dark:border-primary/20 rounded-lg text-sm font-semibold hover:bg-bronze/5 dark:hover:bg-primary/5 transition">View All Activity</button>
</div>
</div>
</div>
<div class="animate-fade-in max-w-3xl mx-auto" x-cloak="" x-show="activeView === 'edit'">
<div class="bg-accent dark:bg-secondary rounded-xl border border-bronze/10 dark:border-primary/10 shadow-sm p-6 sm:p-8">
<h2 class="text-2xl font-display font-bold text-light-text dark:text-dark-text mb-6">Edit Profile</h2>
<form onsubmit="saveProfile(event)" @submit.prevent="activeView = 'overview'" class="space-y-6"> 
  
    
<div class="flex items-center space-x-6">
  <div class="shrink-0 relative w-24 h-24">
    <!-- Avatar / Preview -->
    <img
      id="avatarPreview"
      data-user-avatar
      alt="Current profile photo"
      class="h-24 w-24 object-cover rounded-full border-4 border-bronze/20 dark:border-primary/20"
    />
  
    <!-- Upload (camera icon) -->
    <label
      class="absolute bottom-0 right-0 bg-bronze dark:bg-primary text-white dark:text-secondary rounded-full p-1.5 cursor-pointer hover:opacity-90 transition shadow-md"
    >
      <span class="material-symbols-outlined text-sm">photo_camera</span>
      <input
        type="file"
        accept="image/*"
        class="sr-only"
        onchange="uploadAvatar(event)"
      />
    </label>
  
    <!-- Remove avatar -->
    <button
      type="button"
      onclick="removeAvatar()"
      class="absolute -top-1 -right-1 bg-danger text-white rounded-full p-1 shadow hover:opacity-90 transition"
      title="Remove photo"
    >
      <span class="material-symbols-outlined text-sm">close</span>
    </button>
  </div>
  
 
      
  
<div>
<h3 class="text-lg font-medium text-light-text dark:text-dark-text">Profile Picture</h3>
<p class="text-sm text-light-text/60 dark:text-dark-text/60">JPG, GIF or PNG. Max size of 800K.</p>
</div>
</div>
<div class="grid grid-cols-1 gap-6">
<div>
<label class="block text-sm font-medium text-light-text/80 dark:text-dark-text/80" for="display-name">Display Name</label>
<input id="display-name" class="mt-1 block w-full rounded-md border-bronze/20 dark:border-primary/20 bg-light-bg dark:bg-dark-bg shadow-sm focus:border-bronze focus:ring-bronze dark:focus:border-primary dark:focus:ring-primary sm:text-sm p-3 transition-colors" id="display-name" name="display-name" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-light-text/80 dark:text-dark-text/80" for="email">Email Address <span class="text-xs text-light-text/50 ml-1">(Read-only)</span></label>
<div class="mt-1 flex rounded-md shadow-sm">
<span class="inline-flex items-center rounded-l-md border border-r-0 border-bronze/20 dark:border-primary/20 bg-bronze/5 dark:bg-primary/5 px-3 text-light-text/50 dark:text-dark-text/50">
<span class="material-symbols-outlined text-sm">email</span>
</span>
<input id="email" class="block w-full flex-1 rounded-none rounded-r-md border-bronze/20 dark:border-primary/20 bg-bronze/5 dark:bg-primary/5 text-light-text/60 dark:text-dark-text/60 sm:text-sm p-3 cursor-not-allowed" disabled="" id="email" name="email" type="email"/>
</div>
</div>
</div>
<div class="flex items-center justify-end space-x-3 pt-6 border-t border-bronze/10 dark:border-primary/10">
<button @click="activeView = 'overview'" class="px-4 py-2 text-sm font-semibold rounded-lg border border-bronze/30 dark:border-primary/30 text-light-text dark:text-dark-text hover:bg-bronze/10 dark:hover:bg-primary/10 transition" type="button">
                                Cancel
                            </button>
                            <button
                            class="px-6 py-2 text-sm font-semibold rounded-lg bg-bronze dark:bg-primary text-white dark:text-secondary hover:opacity-90 transition shadow-md flex items-center"
                            type="button"
                            onclick="saveProfileName()"
                          >
                            <span class="material-symbols-outlined text-sm mr-2">save</span>
                            Save Changes
                          </button>
                          
</div>
</form>
</div>
</div>
<div class="animate-fade-in" x-cloak="" x-show="activeView === 'orders'">
<div class="flex justify-between items-center mb-6">
<h2 class="text-2xl font-display font-bold text-light-text dark:text-dark-text">My Orders</h2>
</div>
<div
  id="orders-table-wrapper"
  class="bg-accent dark:bg-secondary rounded-xl border border-bronze/10 dark:border-primary/10 shadow-sm overflow-hidden animate-fade-in-up"
><div class="overflow-x-auto">
<table class="w-full text-sm text-left">
<thead class="text-xs text-light-text/60 dark:text-dark-text/60 uppercase bg-light-bg/50 dark:bg-dark-bg/50 border-b border-bronze/10 dark:border-primary/10">
<tr>
<th class="px-6 py-4 font-semibold" scope="col">Order ID</th>
<th class="px-6 py-4 font-semibold" scope="col">Date</th>
<th class="px-6 py-4 font-semibold" scope="col">Status</th>
<th class="px-6 py-4 font-semibold text-right" scope="col">Total</th>
<th class="px-6 py-4 font-semibold text-center" scope="col">Action</th>
</tr>
</thead>
<tbody id="orders-body"></tbody>

</table>
</div>
</div>
<!-- PAGINATION -->
<div id="user-pagination"
     class="flex justify-center gap-2 p-4 border-t border-bronze/10 dark:border-primary/10">
</div>
<script>
  function renderUserPagination() {
  const container = document.getElementById("user-pagination");
  if (!container) return;

  container.innerHTML = "";

  const total = totalPages();
  if (total <= 1) return;

  // Prev
  const prev = document.createElement("button");
  prev.textContent = "Prev";
  prev.className =
    "px-3 py-1 rounded border border-bronze/30 dark:border-primary/30 " +
    "text-light-text dark:text-dark-text hover:bg-bronze/10 dark:hover:bg-primary/10 transition";
  prev.disabled = currentPage === 1;
  prev.onclick = () => goToPage(Math.max(1, currentPage - 1));
  container.appendChild(prev);

  // Numbers
  const pages = getVisiblePages(currentPage, total);

  pages.forEach(p => {
    const btn = document.createElement("button");
    btn.textContent = p;
    btn.className =
      "px-3 py-1 rounded transition " +
      (p === currentPage
        ? "bg-primary text-white border border-primary"
        : "border border-bronze/30 dark:border-primary/30 text-light-text dark:text-dark-text hover:bg-bronze/10 dark:hover:bg-primary/10");

    btn.onclick = () => goToPage(p);
    container.appendChild(btn);
  });

  // Next
  const next = document.createElement("button");
  next.textContent = "Next";
  next.className =
    "px-3 py-1 rounded border border-bronze/30 dark:border-primary/30 " +
    "text-light-text dark:text-dark-text hover:bg-bronze/10 dark:hover:bg-primary/10 transition";
  next.disabled = currentPage === total;
  next.onclick = () => goToPage(Math.min(total, currentPage + 1));
  container.appendChild(next);
}

</script>
<div
  id="orders-empty"
  class="bg-accent dark:bg-secondary rounded-xl border border-bronze/10 dark:border-primary/10 shadow-sm p-12 text-center animate-fade-in hidden"
><div class="h-20 w-20 bg-bronze/10 dark:bg-primary/10 text-bronze dark:text-primary rounded-full flex items-center justify-center mx-auto mb-4">
<span class="material-symbols-outlined text-4xl">shopping_bag</span>
</div>
<h3 class="text-xl font-display font-bold text-light-text dark:text-dark-text mb-2">No orders placed yet</h3>
<p class="text-light-text/60 dark:text-dark-text/60 max-w-sm mx-auto mb-6">Discover our exclusive collection of Oud and Musk fragrances.</p>
<a
  href="productlisted.html"
  class="inline-block px-6 py-2.5 bg-bronze dark:bg-primary
         text-white dark:text-secondary font-semibold rounded-lg
         hover:opacity-90 transition shadow-md"
>
  Start Shopping
</a>

</div>
</div>
<div class="animate-fade-in max-w-2xl mx-auto" x-cloak="" x-show="activeView === 'security'">
  <div class="space-y-8">

<!-- ================= CHANGE PASSWORD (LOCAL USERS) ================= -->
<button
  x-show="user && user.provider === 'local'"
  @click="showPasswordPanel = !showPasswordPanel"
  class="w-full px-6 py-4 bg-bronze dark:bg-primary text-white
         rounded-xl font-semibold flex items-center justify-between"
>
  Update Password
  <span class="material-symbols-outlined"
        x-text="showPasswordPanel ? 'expand_less' : 'expand_more'"></span>
</button>

<div
  x-show="showPasswordPanel && user && user.provider === 'local'"
  x-collapse
  class="mt-4 bg-accent dark:bg-secondary rounded-xl
         border border-bronze/10 dark:border-primary/10
         shadow-sm p-6 sm:p-8"
>
  <div class="flex items-center mb-6">
    <span class="p-2 rounded-lg bg-bronze/10 dark:bg-primary/10 text-bronze dark:text-primary mr-3">
      <span class="material-symbols-outlined">lock_reset</span>
    </span>
    <h2 class="text-xl font-display font-bold">Change Password</h2>
  </div>

  <form class="space-y-4">
    <div>
      <label class="text-sm font-medium">Current Password</label>
      <input type="password" id="current-password"
        class="mt-1 w-full rounded-md border p-3" />
      <p id="password-error" class="text-sm text-red-600 mt-2"></p>
    </div>

    <div>
      <label class="text-sm font-medium">New Password</label>
      <input type="password" id="new-password"
        class="mt-1 w-full rounded-md border p-3" />
    </div>

    <div>
      <label class="text-sm font-medium">Confirm New Password</label>
      <input type="password" id="confirm-password"
        class="mt-1 w-full rounded-md border p-3" />
    </div>

    <a href="forgot-password.html"
       class="text-sm text-bronze dark:text-primary underline inline-block">
      Forgot password?
    </a>

    <div class="pt-4 flex justify-end">
      <button
        type="button"
        onclick="changePassword()"
        class="px-6 py-2 rounded-lg bg-bronze dark:bg-primary text-white"
      >
        Update Password
      </button>
    </div>
  </form>
</div>
<button
  x-show="user && (user.provider === 'google' || user.provider === 'facebook')"
  @click="showPasswordPanel = !showPasswordPanel"
  class="w-full px-6 py-4 bg-bronze dark:bg-primary text-white
         rounded-xl font-semibold flex items-center justify-between"
>
  Set Password
  <span class="material-symbols-outlined"
        x-text="showPasswordPanel ? 'expand_less' : 'expand_more'"></span>
</button>


<!-- ================= SET PASSWORD (OAUTH USERS) ================= -->
<div
  x-show="showPasswordPanel && user && (user.provider === 'google' || user.provider === 'facebook')"
  x-collapse
  class="mt-4 bg-accent dark:bg-secondary rounded-xl
         border border-bronze/10 dark:border-primary/10
         shadow-sm p-6 sm:p-8"
>
  <div class="flex items-center mb-6">
    <span class="p-2 rounded-lg bg-bronze/10 dark:bg-primary/10 text-bronze dark:text-primary mr-3">
      <span class="material-symbols-outlined">lock</span>
    </span>
    <h2 class="text-xl font-display font-bold">Set Password</h2>
  </div>

  <form class="space-y-4">
    <div>
      <label class="text-sm font-medium">New Password</label>
      <input type="password" class="mt-1 w-full rounded-md border p-3" />
    </div>

    <div>
      <label class="text-sm font-medium">Confirm Password</label>
      <input type="password" class="mt-1 w-full rounded-md border p-3" />
    </div>

    <p class="text-xs text-light-text/60">
      Password must be at least 8 characters.
    </p>

    <div class="pt-4 flex justify-end">
      <button
        type="button"
        onclick="setPassword()"
        class="px-6 py-2 rounded-lg bg-bronze dark:bg-primary text-white"
      >
        Set Password
      </button>
    </div>
  </form>
</div>



 <button
 @click="showSessionPanel = !showSessionPanel"
 class="w-full px-6 py-4
        bg-bronze/10 text-bronze
        border border-bronze/30
        rounded-xl font-semibold
        flex items-center justify-between
        hover:bg-bronze/20 transition"
>
 Session Management
 <span class="material-symbols-outlined"
       x-text="showSessionPanel ? 'expand_less' : 'expand_more'"></span>
</button>

  
<div
  x-show="showSessionPanel"
  x-collapse
  class="mt-4 bg-accent dark:bg-secondary
         border border-bronze/20
         rounded-xl shadow-sm
         p-6 sm:p-8 relative overflow-hidden"
>

  <div class="absolute top-0 right-0 p-4 opacity-10">
    <span class="material-symbols-outlined text-9xl text-bronze opacity-10">
      no_accounts
    </span>
    
  </div>

  <h3 class="text-lg font-bold text-danger mb-2 font-display">
    Session Management
  </h3>

  <p class="text-sm text-light-text/70 dark:text-dark-text/70 mb-6 max-w-md">
    Did you forget to sign out on a public computer? This will log you out
    from all devices except this one.
  </p>

  <button
    type="button"
    onclick="logoutAllDevices()"
    class="px-4 py-2 bg-danger/10 text-danger border
           border-danger/20 rounded-lg hover:bg-danger/20
           transition font-semibold text-sm flex items-center"
  >
    <span class="material-symbols-outlined text-sm mr-2">logout</span>
    Logout from all devices
  </button>
</div>


  
<button
@click="showDeletePanel = !showDeletePanel"
class="w-full px-6 py-4
       bg-danger text-white
       rounded-xl font-semibold
       flex items-center justify-between
       hover:bg-danger/90 transition"
>
Delete Account
<span class="material-symbols-outlined"
      x-text="showDeletePanel ? 'expand_less' : 'expand_more'"></span>
</button>


<!-- ================= DELETE ACCOUNT ================= -->
<div
  x-show="showDeletePanel"
  x-transition
  class="mt-4 bg-danger/5
         border border-danger/30
         rounded-xl p-6"
>

<h3 class="text-lg font-bold text-danger mb-2 font-display">
  Delete Account
</h3>

<p class="text-sm text-danger/80 mb-4">
  This action is permanent. Your account will be disabled and you will
  be logged out immediately.
</p>

<!-- PASSWORD (local users only) -->
<div x-show="user && user.provider === 'local'" class="mb-4">
    <label class="text-sm font-medium text-danger">
    Confirm Password
  </label>
  <input
    id="delete-password"
    type="password"
    class="mt-1 w-full rounded-md
           border border-danger/30 p-3"
    placeholder="Enter your password"
  />
</div>

<button
  type="button"
  onclick="deleteAccount()"
  class="px-4 py-2 bg-danger text-white rounded-lg
         hover:bg-danger/90 transition font-semibold text-sm"
>
  Permanently Delete Account
</button>
</div>
  
</div>



  
</div>
<!-- ================= DETAILS ================= -->
<div
  class="animate-fade-in max-w-3xl mx-auto"
  x-cloak
  x-show="activeView === 'details'"
>
  <div
    class="bg-accent dark:bg-secondary
           rounded-2xl border border-bronze/10 dark:border-primary/10
           shadow-sm p-6 sm:p-8"
  >
    <!-- Header -->
    <div class="mb-8">
      <h2 class="text-2xl font-display font-bold">
        Personal Details
      </h2>
      <p class="text-sm text-light-text/60 dark:text-dark-text/60 mt-1">
        Used to speed up checkout. Orders will not overwrite these details.
      </p>
    </div>

    <!-- Form -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

      <!-- Full Name -->
      <div>
        <label class="block text-sm font-medium mb-1">Full Name</label>
        <input
          id="details-name"
          type="text"
          placeholder="John Doe"
          class="w-full rounded-lg border border-bronze/20 dark:border-primary/20
                 bg-light-bg dark:bg-dark-bg p-3 text-sm
                 focus:ring-2 focus:ring-bronze dark:focus:ring-primary
                 outline-none transition"
        >
      </div>

      <!-- Phone -->
      <div>
        <label class="block text-sm font-medium mb-1">Phone Number</label>
        <input
          id="details-phone"
          type="text"
          placeholder="07XXXXXXXX"
          class="w-full rounded-lg border border-bronze/20 dark:border-primary/20
                 bg-light-bg dark:bg-dark-bg p-3 text-sm
                 focus:ring-2 focus:ring-bronze dark:focus:ring-primary
                 outline-none transition"
        >
      </div>

      <!-- Address -->
      <div class="md:col-span-2">
        <label class="block text-sm font-medium mb-1">Address</label>
        <input
          id="details-address"
          type="text"
          placeholder="Street address, building, etc."
          class="w-full rounded-lg border border-bronze/20 dark:border-primary/20
                 bg-light-bg dark:bg-dark-bg p-3 text-sm
                 focus:ring-2 focus:ring-bronze dark:focus:ring-primary
                 outline-none transition"
        >
      </div>

      <!-- Province -->
      <div>
        <label class="block text-sm font-medium mb-1">Province</label>
        <input
          id="details-province"
          type="text"
          placeholder="Western Province"
          class="w-full rounded-lg border border-bronze/20 dark:border-primary/20
                 bg-light-bg dark:bg-dark-bg p-3 text-sm
                 focus:ring-2 focus:ring-bronze dark:focus:ring-primary
                 outline-none transition"
        >
      </div>

      <!-- District -->
      <div>
        <label class="block text-sm font-medium mb-1">District</label>
        <input
          id="details-district"
          type="text"
          placeholder="Colombo"
          class="w-full rounded-lg border border-bronze/20 dark:border-primary/20
                 bg-light-bg dark:bg-dark-bg p-3 text-sm
                 focus:ring-2 focus:ring-bronze dark:focus:ring-primary
                 outline-none transition"
        >
      </div>

      <!-- City -->
      <div>
        <label class="block text-sm font-medium mb-1">City</label>
        <input
          id="details-city"
          type="text"
          placeholder="Dehiwala"
          class="w-full rounded-lg border border-bronze/20 dark:border-primary/20
                 bg-light-bg dark:bg-dark-bg p-3 text-sm
                 focus:ring-2 focus:ring-bronze dark:focus:ring-primary
                 outline-none transition"
        >
      </div>

      <!-- Postal Code -->
      <div>
        <label class="block text-sm font-medium mb-1">Postal Code</label>
        <input
          id="details-postal"
          type="text"
          placeholder="10350"
          class="w-full rounded-lg border border-bronze/20 dark:border-primary/20
                 bg-light-bg dark:bg-dark-bg p-3 text-sm
                 focus:ring-2 focus:ring-bronze dark:focus:ring-primary
                 outline-none transition"
        >
      </div>
    </div>

    <!-- Actions -->
    <div class="flex justify-end mt-8">
      <button
        onclick="saveUserDetails()"
        class="px-6 py-2.5 rounded-lg
               bg-bronze dark:bg-primary
               text-white dark:text-secondary
               font-semibold shadow-md
               hover:opacity-90 active:scale-[0.98]
               transition"
      >
        Save Details
      </button>
    </div>
  </div>
</div>

<script>
  async function saveUserDetails() {
    const payload = {
      name: document.getElementById("details-name").value.trim(),
      phone: document.getElementById("details-phone").value.trim(),
      address: document.getElementById("details-address").value.trim(),
      province: document.getElementById("details-province").value.trim(),
      district: document.getElementById("details-district").value.trim(),
      city: document.getElementById("details-city").value.trim(),
      postalCode: document.getElementById("details-postal").value.trim()
    };
  
    const token = localStorage.getItem("token");
  
    const res = await fetch("https://perfume-store-production.up.railway.app/api/users/profile", {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify(payload)
    });
  
    const data = await res.json();
  
    if (!res.ok) {
      alert(data.message || "Failed to save details");
      return;
    }
  
    // ‚úÖ keep frontend synced
    const user = JSON.parse(localStorage.getItem("user")) || {};
    user.name = data.user.name;
    user.phone = data.user.phone;
    user.address = data.user.address;
    user.profileDetails = data.user.profileDetails;
  
    localStorage.setItem("user", JSON.stringify(user));
  
    alert("Details saved successfully");
  }
  </script>
<script>
  async function loadUserDetailsIntoForm() {
    const token = localStorage.getItem("token");
    if (!token) return;
  
    try {
      const res = await fetch("https://perfume-store-production.up.railway.app/api/users/me", {
        headers: {
          Authorization: `Bearer ${token}`
        }
      });
  
      const data = await res.json();
      if (!res.ok || !data.user) return;
  
      const user = data.user;
  
      // ===== CORE FIELDS =====
      document.getElementById("details-name").value = user.name || "";
      document.getElementById("details-phone").value = user.phone || "";
      document.getElementById("details-address").value = user.address || "";
  
      // ===== PROFILE DETAILS =====
      document.getElementById("details-province").value =
        user.profileDetails?.province || "";
  
      document.getElementById("details-district").value =
        user.profileDetails?.district || "";
  
      document.getElementById("details-city").value =
        user.profileDetails?.city || "";
  
      document.getElementById("details-postal").value =
        user.profileDetails?.postalCode || "";
  
    } catch (err) {
      console.error("Failed to load user details:", err);
    }
  }
  
  // üî• Auto-load when page opens
  document.addEventListener("DOMContentLoaded", loadUserDetailsIntoForm);
  </script>
    

<style>[x-cloak] { display: none !important; }

  [x-collapse] {
    transition: height 0.35s ease;
  }
  </style>

<script>
  async function deleteAccount() {
    if (!confirm("Are you sure? This action cannot be undone.")) return;
  
    const token = localStorage.getItem("token");
    const user = JSON.parse(localStorage.getItem("user"));
    const passwordInput = document.getElementById("delete-password");
  
    const body = {};
  
    // Password only for local users
    if (user.provider === "local") {
      const password = passwordInput?.value;
      if (!password) {
        alert("Password is required");
        return;
      }
      body.password = password;
    }
  
    const res = await fetch("https://perfume-store-production.up.railway.app/api/users/delete-account", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify(body)
    });
  
    const data = await res.json();
  
    // üî¥ IMPORTANT: show backend message
    if (!res.ok) {
      alert(data.message || "Failed to delete account");
      return;
    }
  
    // ‚úÖ SUCCESS
    localStorage.clear();
    alert("Your account has been deleted successfully.");
    window.location.replace("index.html");
  }
  </script>
<script>
  async function logoutAllDevices() {
    if (!confirm("This will log you out from all other devices. Continue?")) {
      return;
    }
  
    const token = localStorage.getItem("token");
  
    try {
      await fetch("https://perfume-store-production.up.railway.app/api/auth/logout-all", {
        method: "POST",
        headers: {
          Authorization: `Bearer ${token}`
        }
      });
    } catch (err) {
      // ignore error ‚Äî still logout locally
    }
  
    // üî• CLEAR SESSION
    localStorage.removeItem("token");
    localStorage.removeItem("user");
  
    // üî• FORCE EXIT PROFILE
    window.location.replace("index.html");
  }
  </script>
<script>
  async function setPassword() {
    const container = document.querySelector(
      "[x-show*='facebook'], [x-show*='google']"
    );
  
    const inputs = container.querySelectorAll("input");
    const password = inputs[0].value;
    const confirm = inputs[1].value;
  
    if (!password || !confirm) {
      showToast("All fields are required");
      return;
    }
  
    if (password.length < 8) {
      showToast("Password must be at least 8 characters");
      return;
    }
  
    if (password !== confirm) {
      showToast("Passwords do not match");
      return;
    }
  
    const token = localStorage.getItem("token");
  
    const res = await fetch("https://perfume-store-production.up.railway.app/api/auth/set-password", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify({ newPassword: password })
    });
  
    const data = await res.json();
  
    if (!res.ok) {
      showToast(data.message || "Failed to set password");
      return;
    }
  
    showToast("Password set successfully");
  
    // update local user
    const user = JSON.parse(localStorage.getItem("user"));
    user.provider = "local";
    localStorage.setItem("user", JSON.stringify(user));
  
    location.reload();
  }
  </script>
  
  <script>
    async function changePassword() {
      const current = document.getElementById("current-password").value;
      const next = document.getElementById("new-password").value;
      const confirm = document.getElementById("confirm-password").value;
    
      // clear old error
      const errorBox = document.getElementById("password-error");
      if (errorBox) errorBox.textContent = "";
    
      if (!current || !next || !confirm) {
        showToast("All fields are required");
        return;
      }
    
      if (next.length < 8) {
        showToast("Password must be at least 8 characters");
        return;
      }
    
      if (next !== confirm) {
        showToast("New passwords do not match");
        return;
      }
    
      const token = localStorage.getItem("token");
    
      const res = await fetch("https://perfume-store-production.up.railway.app/api/auth/change-password", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({
          currentPassword: current,
          newPassword: next
        })
      });
    
      const data = await res.json();
    
      if (!res.ok) {
        // ‚úÖ THIS IS THE IMPORTANT PART
        if (errorBox) {
          errorBox.textContent = data.message || "Password update failed";
        } else {
          showToast(data.message || "Password update failed");
        }
        return;
      }
    
      showToast("Password updated successfully");
    
      // optional: clear inputs
      document.getElementById("current-password").value = "";
      document.getElementById("new-password").value = "";
      document.getElementById("confirm-password").value = "";
    }
    </script>
</div>

</main>
</div>
<div class="lg:hidden" x-cloak="" x-show="mobileMenuOpen">
<div @click="mobileMenuOpen = false" class="fixed inset-0 bg-black/50 z-40" x-transition:enter="transition-opacity ease-linear duration-300" x-transition:enter-end="opacity-100" x-transition:enter-start="opacity-0" x-transition:leave="transition-opacity ease-linear duration-300" x-transition:leave-end="opacity-0" x-transition:leave-start="opacity-100"></div>
<aside class="fixed inset-y-0 right-0 w-72
             bg-accent dark:bg-secondary z-50
             animate-slide-in-right
             flex flex-col h-full
             shadow-2xl
             overflow-y-auto">
             <div class="flex items-center justify-between h-20 px-6 border-b border-bronze/10 dark:border-primary/10">
<a class="flex items-center gap-3" href="#">
<div class="h-8 w-8 text-bronze dark:text-primary"><svg fill="currentColor" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path d="M24 0.757355L47.2426 24L24 47.2426L0.757355 24L24 0.757355ZM21 35.7574V12.2426L9.24264 24L21 35.7574Z"></path></svg></div>
<span class="text-xl font-bold font-display text-light-text dark:text-accent">Hirah Attar</span>
</a>
<button @click="mobileMenuOpen = false"><span class="material-symbols-outlined">close</span></button>
</div>
<div class="p-6 flex flex-col items-center justify-center border-b border-bronze/10 dark:border-primary/10">
<img data-user-avatar alt="User Avatar" class="h-16 w-16 rounded-full object-cover border-2 border-bronze dark:border-primary shadow-md"/>
<h3 class="mt-3 font-display font-bold text-lg text-center" x-text="user.name"></h3>
<p class="text-xs text-light-text/60 dark:text-dark-text/60" x-text="user.email"></p>
</div>
<nav class="flex-grow pt-4 px-4 space-y-2">
<a :class="{'bg-bronze/10 dark:bg-primary/10 text-bronze dark:text-primary': activeView === 'overview'}" @click.prevent="activeView = 'overview'; mobileMenuOpen = false" class="flex items-center p-3 rounded-lg" href="#"><span class="material-symbols-outlined">badge</span><span class="ml-4 font-semibold">Overview</span></a>
<a :class="{'bg-bronze/10 dark:bg-primary/10 text-bronze dark:text-primary': activeView === 'edit'}" @click.prevent="activeView = 'edit'; mobileMenuOpen = false" class="flex items-center p-3 rounded-lg" href="#"><span class="material-symbols-outlined">edit_square</span><span class="ml-4 font-semibold">Edit Profile</span></a>
<a :class="{'bg-bronze/10 dark:bg-primary/10 text-bronze dark:text-primary': activeView === 'orders'}" @click.prevent="activeView = 'orders'; mobileMenuOpen = false" class="flex items-center p-3 rounded-lg" href="#"><span class="material-symbols-outlined">shopping_bag</span><span class="ml-4 font-semibold">My Orders</span></a>
<a :class="{'bg-bronze/10 dark:bg-primary/10 text-bronze dark:text-primary': activeView === 'security'}" @click.prevent="activeView = 'security'; mobileMenuOpen = false" class="flex items-center p-3 rounded-lg" href="#"><span class="material-symbols-outlined">lock</span><span class="ml-4 font-semibold">Security</span></a>
<!-- DETAILS -->
<a
  :class="{
    'bg-bronze/10 dark:bg-primary/10 text-bronze dark:text-primary': activeView === 'details',
    'hover:bg-bronze/5 dark:hover:bg-primary/5': activeView !== 'details'
  }"
  @click.prevent="activeView = 'details'"
  class="sidebar-group flex items-center p-3 rounded-lg transition-all duration-200 cursor-pointer"
  style="--hover-color: #A97142;"
>
  <span class="material-symbols-outlined sidebar-icon">contact_mail</span>
  <span
    :class="{'opacity-100 w-auto': sidebarOpen, 'opacity-0 w-0': !sidebarOpen}"
    class="ml-4 font-semibold sidebar-label whitespace-nowrap overflow-hidden transition-all duration-200"
  >
    Details
  </span>
</a>

</nav>
<div class="p-4 border-t border-bronze/10 dark:border-primary/10">
<a onclick="logout()" class="flex items-center p-3 rounded-lg text-danger hover:bg-danger/10" href="#"><span class="material-symbols-outlined">logout</span><span class="ml-4 font-semibold">Logout</span></a>
</div>
</aside>
</div>
</div>
<script>
  function loadUser() {
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user) {
      window.location.href = "index.html";
      return null;
    }
    return user;
  }
</script>
<script>
  (function () {
    const root = document.documentElement;
  
    // restore theme
    const savedTheme = localStorage.getItem("theme");
    if (savedTheme === "dark") {
      root.classList.add("dark");
    } else {
      root.classList.remove("dark");
    }
  
    // global toggle
    window.toggleTheme = function () {
      const isDark = root.classList.toggle("dark");
      localStorage.setItem("theme", isDark ? "dark" : "light");
    };
  })();
  </script>
<script>
let myOrders = [];
let currentPage = 1;
const perPage = 5;
function getVisiblePages(current, total) {
  if (total <= 3) {
    return Array.from({ length: total }, (_, i) => i + 1);
  }

  if (current <= 2) {
    return [1, 2, 3];
  }

  if (current >= total - 1) {
    return [total - 2, total - 1, total];
  }

  return [current - 1, current, current + 1];
}  

function openOrdersView() {
  // DOM is guaranteed to exist here
  const table = document.getElementById("orders-table-wrapper");
  const empty = document.getElementById("orders-empty");

  if (!table || !empty) return;

  if (myOrders.length === 0) {
    table.classList.add("hidden");
    empty.classList.remove("hidden");
    document.getElementById("user-pagination").innerHTML = "";
    return;
  }

  empty.classList.add("hidden");
  table.classList.remove("hidden");

  renderOrders();
  renderUserPagination();
}


async function loadMyOrders() {
  const token = localStorage.getItem("token");
  if (!token) return;

  try {
    const res = await fetch("https://perfume-store-production.up.railway.app/api/orders/my", {
      headers: { Authorization: `Bearer ${token}` }
    });

    const data = await res.json();
    if (!data.success) {
      alert("Failed to load orders");
      return;
    }

    // ‚úÖ 1. STORE DATA ONLY
    myOrders = Array.isArray(data.orders) ? data.orders : [];

    // ‚úÖ 2. UPDATE DASHBOARD STATS (SAFE ANYTIME)
    const deliveredOrders = myOrders.filter(
      o => o.orderStatus === "delivered"
    );

    const totalSpent = deliveredOrders.reduce(
      (sum, o) => sum + Number(o.total || 0),
      0
    );

    document.getElementById("totalSpent").textContent =
      "Rs. " + totalSpent.toFixed(2);

    document.getElementById("totalOrdersCount").textContent =
      myOrders.length;

    document.getElementById("completedOrdersCount").textContent =
      deliveredOrders.length;

    // ‚úÖ 3. RESET PAGINATION STATE ONLY
    currentPage = 1;

    // ‚ùå IMPORTANT:
    // DO NOT call renderOrders() here
    // DO NOT call renderUserPagination() here

  } catch (err) {
    console.error("loadMyOrders failed:", err);
    alert("Something went wrong while loading orders");
  }
}


 
  function totalPages() {
  return Math.ceil(myOrders.length / perPage);
}

function formatJoinedDate(dateString) {
  if (!dateString) return "‚Äî";

  const date = new Date(dateString);
  if (isNaN(date)) return "‚Äî";

  return date.toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric"
  });
}

const user = getUser();
if (user?.createdAt) {
  document.getElementById("joinedDate").textContent =
    formatJoinedDate(user.createdAt);
}
function renderLoyaltyBadge() {
  const user = getUser();
  if (!user) return;

  const tier = (user.loyaltyTier || "bronze").toLowerCase();
  const badge = document.getElementById("loyaltyBadge");
  if (!badge) return;

  const config = {
    bronze:   { label: "Bronze Member",   icon: "workspace_premium", color: "text-bronze" },
    silver:   { label: "Silver Member",   icon: "military_tech",     color: "text-gray-400" },
    gold:     { label: "Gold Member",     icon: "emoji_events",      color: "text-yellow-500" },
    platinum: { label: "Platinum Member", icon: "stars",             color: "text-indigo-400" },
    diamond:  { label: "Diamond Member",  icon: "diamond",           color: "text-primary" }
  };

  const t = config[tier] || config.bronze;

  badge.className = `font-medium mt-1 flex items-center ${t.color}`;
  badge.innerHTML = `
    <span class="material-symbols-outlined text-sm mr-1">${t.icon}</span>
    ${t.label}
  `;
}


function goToPage(page) {
  currentPage = page;
  renderOrders();
  renderUserPagination();
}

  function renderOrders() {
  const tbody = document.getElementById("orders-body");
  tbody.innerHTML = "";

  const start = (currentPage - 1) * perPage;
  const end = start + perPage;
  const pageOrders = myOrders.slice(start, end);

  pageOrders.forEach(order => {

    const tr = document.createElement("tr");

    const statusBadge = getStatusBadge(order.orderStatus);
    const actionButtons = getActionButtons(order);

    tr.innerHTML = `
      <td class="px-6 py-4 font-mono text-sm">
        #${order._id.slice(-6)}
      </td>

      <td class="px-6 py-4">
        ${new Date(order.createdAt).toLocaleDateString()}
      </td>

      <td class="px-6 py-4">
        ${statusBadge}
      </td>

      <td class="px-6 py-4 text-right font-semibold">
        Rs. ${order.total.toFixed(2)}
      </td>

      <td class="px-6 py-4 text-center">
        ${actionButtons}
      </td>
    `;

    tbody.appendChild(tr);
  });
}

function getStatusBadge(status) {
  const colors = {
    pending: "bg-yellow-100 text-yellow-800",
    confirmed: "bg-blue-100 text-blue-800",
    shipped: "bg-purple-100 text-purple-800",
    delivered: "bg-green-100 text-green-800",
    cancelled: "bg-red-100 text-red-800",
    returned: "bg-orange-100 text-red-800" 

  };

  const label =
    status === "delivered" ? "Received" : status.charAt(0).toUpperCase() + status.slice(1);

  return `<span class="px-2 py-1 rounded-full text-xs ${colors[status] || ""}">
            ${label}
          </span>`;
}

  function getActionButtons(order) {
  let buttons = "";

  // ===============================
  // PAY NOW (TEXT BUTTON)
  // ===============================
  if (
  order.paymentStatus === "unpaid" &&
  (order.paymentMethod === "online" || order.paymentMethod === null) &&
  !["cancelled", "shipped", "delivered"].includes(order.orderStatus)
) {

  buttons += `
    <button
      onclick="payOrder('${order._id}')"
      class="text-sm px-4 py-1.5 rounded-full
             bg-bronze text-white hover:bg-bronze/90
             transition-all"
    >
      Pay Now
    </button>
  `;
}

  // ===============================
  // MARK RECEIVED (ICON BUTTON)
  // ===============================
  if (order.orderStatus === "shipped") {
    buttons += `
      <button
        onclick="markReceived('${order._id}')"
        title="Mark as Received"
        class="ml-2 p-2 rounded-full
               bg-green-600 hover:bg-green-700
               text-white transition-all"
      >
        <span class="material-symbols-outlined text-base">
          inventory_2
        </span>
      </button>
    `;
  }

  // ===============================
  // CANCEL (ICON BUTTON)
  // ===============================
  if (["pending", "confirmed"].includes(order.orderStatus)) {
    buttons += `
      <button
        onclick="cancelUserOrder('${order._id}')"
        title="Cancel Order"
        class="ml-2 p-2 rounded-full
               bg-red-600 hover:bg-red-700
               text-white transition-all"
      >
        <span class="material-symbols-outlined text-base">
          cancel
        </span>
      </button>
    `;
  }

  return buttons || "-";
}


async function cancelUserOrder(orderId) {
  if (!confirm("Are you sure you want to cancel this order?")) return;

  const token = localStorage.getItem("token");

  const res = await fetch(`https://perfume-store-production.up.railway.app/api/orders/${orderId}/cancel-user`, {
    method: "PUT",
    headers: {
      Authorization: `Bearer ${token}`
    }
  });

  const data = await res.json();

  if (!data.success) {
    alert(data.message || "Cancel failed");
    return;
  }

  loadMyOrders();
}

async function payOrder(orderId) {
  try {
    const token = localStorage.getItem("token");
    if (!token) {
      alert("Please login again");
      return;
    }

    // 1Ô∏è‚É£ Fetch the saved order (USER API)
    const res = await fetch(`https://perfume-store-production.up.railway.app/api/orders/${orderId}`, {
      headers: {
        Authorization: `Bearer ${token}`
      }
    });

    const data = await res.json();
    if (!data.success) {
      alert(data.message || "Failed to load order");
      return;
    }

    const order = data.order;

    // 2Ô∏è‚É£ Rebuild cart from order items
    const cart = order.items.map(item => ({
  productId: item.productId,          // ‚úÖ FIX
  name: item.name,
  size: item.size,
  qty: Number(item.qty),
  price: Number(item.price),          // ‚úÖ FIX (price, not unitPrice)
  variant: item.variant,
  image: item.image                   // ‚úÖ ALREADY FLAT
}));



    // 3Ô∏è‚É£ Save cart again
    localStorage.setItem("cart", JSON.stringify(cart));

    // 4Ô∏è‚É£ Redirect to checkout
    window.location.href = `checkout.html?orderId=${order._id}`;

  } catch (err) {
    console.error("Pay Now redirect failed:", err);
    alert("Something went wrong");
  }
}

  
  async function markReceived(orderId) {
  const token = localStorage.getItem("token");
  if (!token) return;

  try {
    const res = await fetch(
      `https://perfume-store-production.up.railway.app/api/orders/${orderId}/received`,
      {
        method: "PUT",
        headers: { Authorization: `Bearer ${token}` }
      }
    );

    const data = await res.json();

    if (!data.success) {
      alert(data.message || "Failed to mark received");
      return;
    }

    // üîí HARD GATE: only open modal AFTER backend confirms delivered
    if (
      data.reviewQueue &&
      Array.isArray(data.reviewQueue) &&
      data.reviewQueue.some(q => q.reviewed === false)
    ) {
      const cleanQueue = data.reviewQueue
        .filter(q => q.reviewed === false)
        .map(q => ({ id: q.productId }));

      const hydrated = await hydrateQueue(cleanQueue);

      openReviewModal(hydrated, orderId);
    }

    // Refresh orders AFTER modal logic
    setTimeout(loadMyOrders, 600);

  } catch (err) {
    console.error("markReceived failed:", err);
    alert("Network error");
  }
}




function tryOpenReviewModal() {
  if (!window.__pendingReviewQueue) return;

  const payload = window.__pendingReviewQueue;

  if (!payload.queue || payload.queue.length === 0) {
    window.__pendingReviewQueue = null;
    return;
  }

  openReviewModal(payload.queue, payload.orderId);
  window.__pendingReviewQueue = null;
}





  document.addEventListener("DOMContentLoaded", loadMyOrders);
  </script>
    <!-- ================= REVIEW MODAL ================= -->



    <script>
      let reviewState = {
        open: false,
        queue: [],
        index: 0,
        rating: 0,
        comment: "",
        orderId: null
      };
    
      function openReviewModal(queue, orderId, startIndex = 0) {
  if (reviewState.open === true) return;
  if (!Array.isArray(queue) || queue.length === 0) return;
  if (!orderId) return;

  reviewState.open = true;
  reviewState.queue = queue;
  reviewState.index = startIndex;
  reviewState.rating = 0;
  reviewState.comment = "";
  reviewState.orderId = orderId;

  renderReview();
  document.getElementById("reviewModal").classList.remove("hidden");
}



    
      function renderReview() {
        const item = reviewState.queue[reviewState.index];
    
        // Progress
        document.getElementById("reviewProgress").textContent =
          `${reviewState.index + 1} of ${reviewState.queue.length}`;
    
        // Steps
        const steps = document.getElementById("reviewSteps");
        steps.innerHTML = "";
        reviewState.queue.forEach((_, idx) => {
          const dot = document.createElement("div");
          dot.className =
            "h-1 w-4 rounded-full transition-colors duration-300 " +
            (idx <= reviewState.index ? "bg-primary" : "bg-primary/20");
          steps.appendChild(dot);
        });
    
        // Product info
        document.getElementById("reviewName").textContent = item.name || "Product";
        document.getElementById("reviewImage").src = item.image || "";
    
        // Stars
        const stars = document.getElementById("reviewStars");
        stars.innerHTML = "";
        for (let i = 1; i <= 5; i++) {
          const btn = document.createElement("button");
          btn.className = "transition-transform duration-200 active:scale-75 group";
          btn.onclick = () => setRating(i);
    
          const span = document.createElement("span");
          span.className =
            "material-symbols-outlined text-5xl select-none transition-all group-hover:scale-110 " +
            (i <= reviewState.rating
              ? "filled text-primary drop-shadow-[0_0_12px_rgba(200,155,63,0.6)]"
              : "text-primary/20");
    
          span.textContent = "star";
          btn.appendChild(span);
          stars.appendChild(btn);
        }
    
        // Comment
        document.getElementById("reviewComment").value = reviewState.comment;
    
        // Button label
        document.getElementById("reviewDoneLabel").textContent =
          reviewState.index < reviewState.queue.length - 1 ? "Done & Next" : "Done";
      }
    
      function setRating(i) {
        reviewState.rating = i;
        renderReview();
      }
    
      function reviewDone() {
        if (reviewState.index < reviewState.queue.length - 1) {
          reviewState.index++;
          reviewState.rating = 0;
          reviewState.comment = "";
          renderReview();
        } else {
          reviewCancel();
        }
      }
    
      function reviewSkip() {
  if (!reviewState.queue.length) return;

  // remove current item completely
  reviewState.queue.splice(reviewState.index, 1);

  reviewState.rating = 0;
  reviewState.comment = "";

  if (reviewState.queue.length === 0) {
    reviewCancel(); // üîí close modal when empty
    return;
  }

  // stay in bounds
  if (reviewState.index >= reviewState.queue.length) {
    reviewState.index = 0;
  }

  renderReview();
}

      function reviewCancel() {
  reviewState.open = false;
  reviewState.queue = [];
  reviewState.index = 0;
  reviewState.rating = 0;
  reviewState.comment = "";
  reviewState.orderId = null;

  const modal = document.getElementById("reviewModal");
  if (modal) modal.classList.add("hidden");
}


    </script>
    
    

  
<!-- ================= REVIEW MODAL ================= -->
<div
  id="reviewModal"
  class="fixed inset-0 z-50 flex items-center justify-center p-4 sm:p-6 hidden"
>
  <!-- Backdrop -->
  <div
    onclick="reviewCancel()"
    class="fixed inset-0 bg-black/80 backdrop-blur-md transition-opacity duration-300"
  ></div>

  <div
    class="relative w-full max-w-lg bg-[#070b14]/95 border border-primary/20 rounded-[16px]
           shadow-[0_25px_60px_rgba(0,0,0,0.8)] overflow-hidden animate-pop-in"
  >
    <!-- Header -->
    <div class="bg-primary/5 px-6 py-2 border-b border-primary/10 flex justify-center items-center">
      <span
        id="reviewProgress"
        class="text-[10px] uppercase tracking-[0.3em] font-bold text-primary/80"
      ></span>

      <div id="reviewSteps" class="ml-4 flex gap-1"></div>
    </div>

    <!-- Product Info -->
    <div class="flex items-center justify-between p-6 border-b border-primary/10">
      <div class="flex items-center space-x-4">
        <div class="h-12 w-12 rounded-lg overflow-hidden border border-primary/30 flex-shrink-0 bg-secondary">
          <img
            id="reviewImage"
            alt="Product"
            class="w-full h-full object-cover"
          />
        </div>

        <h2 class="text-xl sm:text-2xl font-display font-bold text-accent truncate max-w-[200px]">
          Rate
          <span class="text-primary italic" id="reviewName"></span>
        </h2>
      </div>

      <button
        onclick="reviewCancel()"
        class="h-8 w-8 flex items-center justify-center rounded-full hover:bg-primary/10
               text-primary transition-all active:scale-90"
      >
        <span class="material-symbols-outlined text-xl">close</span>
      </button>
    </div>

    <!-- Body -->
    <div class="relative">
      <div class="review-slide-enter p-8 space-y-8">
        <!-- Stars -->
        <div class="flex flex-col items-center space-y-3">
          <p class="text-xs uppercase tracking-[0.2em] text-primary/60 font-semibold">
            Overall Experience
          </p>

          <div id="reviewStars" class="flex gap-2"></div>
        </div>

        <!-- Comment -->
        <div class="space-y-3">
          <label
            class="text-xs uppercase tracking-widest text-primary/60 font-semibold ml-1"
          >
            Your Thoughts
          </label>

          <textarea
            id="reviewComment"
            oninput="reviewState.comment = this.value"

            class="glass-input w-full rounded-xl p-4 text-accent
                   placeholder:text-accent/30 focus:ring-1 focus:ring-primary/50
                   focus:border-primary/50 outline-none resize-none transition-all"
            placeholder="Write your review here..."
            rows="4"
          ></textarea>
        </div>

        <!-- Buttons -->
        <div class="flex flex-col space-y-4 pt-2">
          <div class="flex gap-4">
            <button
            onclick="submitCurrentReview()"
            class="flex-1 bg-primary text-secondary font-bold py-4 rounded-xl
                   shadow-glow-gold hover:brightness-110 active:scale-[0.98]
                   transition-all flex items-center justify-center"
          >
          
              <span id="reviewDoneLabel"></span>
            </button>

            <button
              onclick="reviewSkip()"
              class="flex-1 border border-primary/50 text-primary font-bold py-4 rounded-xl
                     hover:bg-primary/5 active:scale-[0.98] transition-all"
            >
              Skip
            </button>
          </div>

          <button
            onclick="reviewCancel()"
            class="w-full text-danger/60 hover:text-danger text-sm font-semibold py-2
                   transition-colors active:scale-95"
          >
            Cancel Review
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  async function hydrateQueue(queue) {
    const token = localStorage.getItem("token");
    const result = [];
  
    for (const q of queue) {
      try {
        const res = await fetch(`https://perfume-store-production.up.railway.app/api/products/${q.id}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
  
        const data = await res.json();
  
        if (data.success && data.product) {
          result.push({
            ...q,
            name: data.product.name,
            image: data.product.images?.[0]
  ? `https://perfume-store-production.up.railway.app/${data.product.images[0]}`
  : (data.product.image || "")
          });
        } else {
          result.push({ ...q, name: "Product", image: "" });
        }
      } catch (err) {
        console.error("Hydration failed:", err);
        result.push({ ...q, name: "Product", image: "" });
      }
    }
  
    return result;
  }
 
 
 
 </script>
  
<script>
async function submitCurrentReview() {
  if (!reviewState.queue.length) return;

  const token = localStorage.getItem("token");
  if (!token) {
    alert("Not logged in");
    return;
  }

  const item = reviewState.queue[reviewState.index];

  if (!reviewState.rating) {
    alert("Please select a rating");
    return;
  }

  try {
    const res = await fetch("https://perfume-store-production.up.railway.app/api/products/reviews", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify({
        productId: item.id,
        orderId: reviewState.orderId,
        rating: reviewState.rating,
        comment: reviewState.comment || ""
      })
    });

    const data = await res.json();
    if (!data.success) {
      alert(data.message || "Review failed");
      return;
    }

    // üîí Remove reviewed item permanently from queue
    reviewState.queue.splice(reviewState.index, 1);

    reviewState.rating = 0;
    reviewState.comment = "";

    if (reviewState.queue.length > 0) {
      reviewState.index = 0;
      renderReview();
    } else {
      reviewCancel(); // close only when empty
    }

    // refresh backend truth
    setTimeout(loadMyOrders, 600);

  } catch (err) {
    console.error("Review submit failed:", err);
    alert("Network error");
  }
}




async function reviewOrderManually(orderId, startProductId = null) {
  const order = myOrders.find(o => o._id === orderId);
  if (!order) return;

  if (order.orderStatus !== "delivered") {
    alert("You can review only after receiving the order.");
    return;
  }

  const cleanQueue = order.reviewQueue
    .filter(q => q.reviewed === false)
    .map(q => ({ id: q.productId }));

  if (!cleanQueue.length) {
    alert("All products in this order are already reviewed.");
    return;
  }

  const hydrated = await hydrateQueue(cleanQueue);

  let startIndex = 0;
  if (startProductId) {
    const idx = hydrated.findIndex(
      p => String(p.id) === String(startProductId)
    );
    if (idx >= 0) startIndex = idx;
  }

  openReviewModal(hydrated, orderId, startIndex);
}


</script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
  const params = new URLSearchParams(window.location.search);
  const orderId = params.get("reviewOrderId");
  const productId = params.get("reviewProductId");

  if (!orderId) return;

  let attempts = 0;

  const waitForOrders = setInterval(() => {
    attempts++;

    if (window.myOrders && window.myOrders.length > 0) {
      clearInterval(waitForOrders);

      reviewOrderManually(orderId, productId);

      window.history.replaceState({}, "", "profile.html");
    }

    if (attempts > 100) {
      clearInterval(waitForOrders);
      console.warn("Review intent timed out");
    }
  }, 100);
});
</script>
  
<script src="js/global.js"></script>
<script>
  document.addEventListener("alpine:init", () => {
    Alpine.store("notificationModal", {
      open: false,
      notifications: [],
  
      show(list) {
        this.notifications = list;
        this.open = true;
      },
  
      close() {
        this.open = false;
      }
    });
  });
  </script>
<!-- üîî NOTIFICATION MODAL (PLAIN JS) -->
<div
  id="notificationModal"
  class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/60"
>
  <div class="bg-accent dark:bg-secondary w-full max-w-lg rounded-xl shadow-xl">
    <!-- Header -->
    <div class="flex justify-between items-center p-4 border-b">
      <h3 class="font-semibold text-lg">All Notifications</h3>
      <button
        onclick="closeNotificationModal()"
        class="text-xl hover:text-danger"
      >
        ‚úï
      </button>
    </div>

    <!-- Body -->
    <div
      id="notificationModalBody"
      class="max-h-[60vh] overflow-y-auto divide-y"
    >
      <!-- Notifications injected here -->
    </div>
  </div>
</div>

<script>
  function openNotificationModal(notifications) {
    const modal = document.getElementById("notificationModal");
    const body = document.getElementById("notificationModalBody");
  
    body.innerHTML = "";
  
    if (!notifications || notifications.length === 0) {
      body.innerHTML = `
        <div class="p-6 text-center text-sm opacity-60">
          No notifications
        </div>
      `;
    } else {
      notifications.forEach(n => {
        const div = document.createElement("div");
        div.className = "p-4";
        div.innerHTML = `
          <p class="font-semibold">${n.title}</p>
          <p class="text-sm opacity-70">${n.message}</p>
        `;
        body.appendChild(div);
      });
    }
  
    modal.classList.remove("hidden");
    modal.classList.add("flex");
  }
  
  function closeNotificationModal() {
    const modal = document.getElementById("notificationModal");
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  }
  
  // Close on background click
  document.getElementById("notificationModal").addEventListener("click", e => {
    if (e.target.id === "notificationModal") {
      closeNotificationModal();
    }
  });
  </script>

  <script>
    function userNotifications() {
      return {
        open: false,
        modalOpen: false,
        notifications: [],
    
        get unread() {
          return this.notifications.filter(n => !n.isRead);
        },
    
        get unreadCount() {
          return this.unread.length;
        },
    
        async loadNotifications() {
          const token = localStorage.getItem("token");
          if (!token) return;
    
          const res = await fetch("https://perfume-store-production.up.railway.app/api/notifications", {
            headers: { Authorization: `Bearer ${token}` }
          });
    
          const data = await res.json();
          if (data.success) {
            this.notifications = data.notifications;
            window.__userNotifications = data.notifications;          }
        },
    
        async markAsRead(n) {
          if (n.isRead) return;
    
          const token = localStorage.getItem("token");
    
          await fetch(
            `https://perfume-store-production.up.railway.app/api/notifications/${n._id}/read`,
            {
              method: "PATCH",
              headers: { Authorization: `Bearer ${token}` }
            }
          );
    
          n.isRead = true;

// keep global list in sync
if (window.__userNotifications) {
  const item = window.__userNotifications.find(x => x._id === n._id);
  if (item) item.isRead = true;
}        }
      };
    }
    </script>
</body></html>